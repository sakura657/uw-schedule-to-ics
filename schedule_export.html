<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>UW Course Schedule → ICS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
      *{box-sizing:border-box;font-family:"Inter",sans-serif}
      body{max-width:900px;margin:0 auto;padding:2rem;color:#222}
      h1{font-size:1.5rem;margin-bottom:1rem}
      textarea{width:100%;min-height:180px;padding:.75rem;border:1px solid #ccc;border-radius:.5rem}
      label{display:block;font-weight:600;margin:.75rem 0 .25rem}
      input,select{padding:.5rem .75rem;border:1px solid #ccc;border-radius:.5rem;width:100%}
      button{margin-top:1.5rem;padding:.75rem 1.25rem;border:0;border-radius:.5rem;background:#c5050c;color:#fff;font-weight:600;cursor:pointer}
      button:disabled{opacity:.4;cursor:not-allowed}
      .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem}
      .notice{background:#f7f7f7;padding:1rem;border-left:4px solid #c5050c;margin:1.5rem 0}
      footer{margin-top:2rem;font-size:.875rem;color:#666;text-align:center}
    </style>
  </head>
  <body>
    <h1>UW‑Madison Course Schedule → iCalendar (.ics)</h1>

    <div class="notice">
      <strong>How to get your HTML source:</strong>
      <ol>
        <li>Log in to <a href="https://my.wisc.edu" target="_blank" rel="noopener">MyUW Home</a>.</li>
        <li>Open <em>Course Schedule</em>.</li>
        <li>Select <em>Term</em> and click <em>Update</em>.</li>
        <li>Right‑click anywhere on the page → <em>View Page Source</em>.</li>
        <li>Select all (<kbd>⌘/Ctrl‑A</kbd>) and copy (<kbd>⌘/Ctrl‑C</kbd>).</li>
        <li>Paste the entire HTML into the box below <em>(make sure your browser language is set to English for consistent parsing)</em>.</li>
      </ol>
    </div>

    <label for="html">1️⃣ Paste full Course Schedule <code>.html</code> here</label>
    <textarea id="html" placeholder="&lt;!doctype html&gt; ..."></textarea>

    <div class="row">
      <div>
        <label for="start">2️⃣ Term begins (e.g. 2025‑09‑03)</label>
        <input type="date" id="start" />
      </div>
      <div>
        <label for="end">3️⃣ Term ends (e.g. 2025‑12‑10)</label>
        <input type="date" id="end" />
      </div>
      <div>
        <label for="alert">4️⃣ Default alert</label>
        <select id="alert">
          <option value="none" selected>None</option>
          <option value="0">At time of event</option>
          <option value="5">5 minutes before</option>
          <option value="10">10 minutes before</option>
          <option value="15">15 minutes before</option>
          <option value="30">30 minutes before</option>
          <option value="60">1 hour before</option>
          <option value="120">2 hours before</option>
          <option value="1440">1 day before</option>
          <option value="2880">2 days before</option>
        </select>
      </div>
    </div>

    <button id="generate">Generate ICS</button>

    <footer>All times are exported with <code>TZID=America/Chicago</code>, automatically respecting Central Time DST changes.</footer>

    <script>
      /* util helpers */
      const pad = (n) => String(n).padStart(2, "0");

      /** convert Date in America/Chicago to "YYYYMMDDTHHmmss" local (no Z) */
      function formatLocal(dt) {
        return (
          dt.getFullYear() +
          pad(dt.getMonth() + 1) +
          pad(dt.getDate()) +
          "T" +
          pad(dt.getHours()) +
          pad(dt.getMinutes()) +
          pad(dt.getSeconds())
        );
      }

      /** map minutes offset to VALARM block */
      function makeAlarm(minutes) {
        if (minutes === null) return "";
        const sign = minutes === 0 ? "" : "-";
        const abs = Math.abs(minutes);
        let trig;
        if (abs % 1440 === 0) trig = `P${abs / 1440}D`;
        else if (abs % 60 === 0) trig = `PT${abs / 60}H`;
        else trig = `PT${abs}M`;
        return (
          "BEGIN:VALARM\r\n" +
          `TRIGGER:${sign}${trig}\r\n` +
          "ACTION:DISPLAY\r\nDESCRIPTION:Reminder\r\nEND:VALARM\r\n"
        );
      }

      document.getElementById("generate").addEventListener("click", () => {
        try {
          const raw = document.getElementById("html").value;
          if (!raw.trim()) throw "Please paste the HTML source!";

          const startStr = document.getElementById("start").value;
          const endStr = document.getElementById("end").value;
          if (!startStr || !endStr) throw "Please set start and end dates.";

          const alertVal = document.getElementById("alert").value;
          const alertMinutes = alertVal === "none" ? null : Number(alertVal);

          const dataMatch = raw.match(/const\s+data\s*=\s*(\{[\s\S]*?\});/);
          if (!dataMatch) throw "Cannot find `const data = { … };` block.";
          const data = JSON.parse(dataMatch[1]);
          const events = data.events;
          const classLocations = (data.classes || []).reduce((acc, c) => {
            acc[c.id] = c.meetings?.[0]?.location || "";
            return acc;
          }, {});

          if (!events?.length) throw "No events found inside data block.";

          // Prepare calendar header (TZID ensures DST correctness)
          let ics =
            "BEGIN:VCALENDAR\r\n" +
            "VERSION:2.0\r\nCALSCALE:GREGORIAN\r\n" +
            "PRODID:-//UW Schedule Export//Web 1.0//EN\r\n" +
            "X-WR-TIMEZONE:America/Chicago\r\n";

          const termStart = new Date(startStr + "T00:00:00");
          const termEnd = new Date(endStr + "T23:59:59");

          /**
           * find first occurrence of weekday >= termStart
           * event.start is like "2023-01-03T09:30:00-06:00" → weekday
           */
          events.forEach((evt) => {
            const evtDate = new Date(evt.start);
            const weekday = evtDate.getUTCDay(); // 0 Sun .. 6 Sat (but in UTC offset). We'll derive local.
            // compute local weekday using America/Chicago offset
            const options = { timeZone: "America/Chicago", weekday: "short" };
            const localWk = new Intl.DateTimeFormat("en-US", options)
              .format(evtDate)
              .substring(0, 2)
              .toUpperCase();
            const wkMap = {
              SU: 0,
              MO: 1,
              TU: 2,
              WE: 3,
              TH: 4,
              FR: 5,
              SA: 6,
            };
            // prefer using numeric weekday consistent with map using original Date
            const wday = weekday;

            // time portion (HH:MM:SS) from original local time string
            const [hh, mm, ss] = evt.start.substr(11, 8).split(":");

            // find first date >= termStart matching weekday
            const first = new Date(termStart);
            while (first.getDay() !== wday) first.setDate(first.getDate() + 1);
            first.setHours(hh, mm, ss, 0);

            const durMs = new Date(evt.end) - new Date(evt.start);
            const endFirst = new Date(first.getTime() + durMs);

            const untilStr = formatLocal(termEnd);
            const dtStartStr = formatLocal(first);
            const dtEndStr = formatLocal(endFirst);

            ics +=
              "BEGIN:VEVENT\r\n" +
              `UID:${crypto.randomUUID()}\r\n` +
              `SUMMARY:${evt.title.replace(/,/g, "\\,")}\r\n` +
              `LOCATION:${(classLocations[evt.id] || "").replace(/,/g, "\\,")}\r\n` +
              `DTSTART;TZID=America/Chicago:${dtStartStr}\r\n` +
              `DTEND;TZID=America/Chicago:${dtEndStr}\r\n` +
              `RRULE:FREQ=WEEKLY;UNTIL=${untilStr};WKST=SU\r\n` +
              makeAlarm(alertMinutes) +
              "END:VEVENT\r\n";
          });

          ics += "END:VCALENDAR";

          const blob = new Blob([ics], { type: "text/calendar" });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = "schedule.ics";
          link.click();
          URL.revokeObjectURL(link.href);
        } catch (err) {
          alert(err);
        }
      });
    </script>
  </body>
</html>
